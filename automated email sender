import os

import smtplib

import csv

from email.mime.multipart import MIMEMultipart

from email.mime.text import MIMEText

from email.mime.base import MIMEBase

from email import encoders

from flask import Flask, render_template, request, flash, redirect, url_for, jsonify

from werkzeug.utils import secure_filename

import pandas as pd

from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)

app.secret_key = os.environ.get('SECRET_KEY', 'your-secret-key-here')

app.config['UPLOAD_FOLDER'] = 'uploads'

app.config['MAX_CONTENT_LENGTH'] = 50 1024 1024

ALLOWED_EXTENSIONS = {'csv', 'txt'}

ATTACHMENT_EXTENSIONS = {'pdf', 'doc', 'docx', 'xls', 'xlsx', 'txt', 'jpg', 'jpeg', 'png', 'gif', 'zip'}

os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

def allowed_file(filename, extensions):

return '.' in filename and filename.rsplit('.', 1)[1].lower() in extensions

def parse_csv(filepath):

recipients = []

try:

df = pd.read_csv(filepath)



if 'email' in df.columns:

for _, row in df.iterrows():

recipient_data = {

'email': row['email'],

'name': row.get('name', ''),

'custom1': row.get('custom1', ''),

'custom2': row.get('custom2', '')

}

recipients.append(recipient_data)

else:

flash('CSV must have an "email" column', 'error')

return None

except Exception as e:

flash(f'Error parsing CSV: {str(e)}', 'error')

return None



return recipients

def personalize_message(template, recipient_data):

message = template

message = message.replace('{name}', recipient_data.get('name', ''))

message = message.replace('{email}', recipient_data.get('email', ''))

message = message.replace('{custom1}', recipient_data.get('custom1', ''))

message = message.replace('{custom2}', recipient_data.get('custom2', ''))

return message

def send_email(smtp_config, recipient, subject, body, attachments=None):

try:

msg = MIMEMultipart()

msg['From'] = smtp_config['from_email']

msg['To'] = recipient['email']

msg['Subject'] = personalize_message(subject, recipient)



personalized_body = personalize_message(body, recipient)

msg.attach(MIMEText(personalized_body, 'plain'))



if attachments:

for attachment_path in attachments:

if os.path.exists(attachment_path):

with open(attachment_path, 'rb') as f:

part = MIMEBase('application', 'octet-stream')

part.set_payload(f.read())

encoders.encode_base64(part)

filename = os.path.basename(attachment_path)

part.add_header('Content-Disposition', f'attachment; filename={filename}')

msg.attach(part)



smtp_port = smtp_config['smtp_port']



if smtp_port == 465:

server = smtplib.SMTP_SSL(smtp_config['smtp_server'], smtp_port)

else:

server = smtplib.SMTP(smtp_config['smtp_server'], smtp_port)

server.starttls()



server.login(smtp_config['username'], smtp_config['password'])

server.send_message(msg)

server.quit()



return True, None

except Exception as e:

return False, str(e)

@app.route('/')

def index():

return render_template('index.html')

@app.route('/send', methods=['POST'])

def send_emails():

smtp_provider = request.form.get('smtp_provider', 'gmail')

custom_smtp = request.form.get('custom_smtp', '')

custom_port = request.form.get('custom_port', '587')

username = request.form.get('username')

password = request.form.get('password')

from_email = request.form.get('from_email')

subject = request.form.get('subject')

message = request.form.get('message')



if not all([username, password, from_email, subject, message]):

flash('Please fill in all required fields', 'error')

return redirect(url_for('index'))



if smtp_provider == 'custom':

if not custom_smtp:

flash('Please enter a custom SMTP server', 'error')

return redirect(url_for('index'))

try:

port_num = int(custom_port)

if port_num < 1 or port_num > 65535:

raise ValueError('Port must be between 1 and 65535')

except (ValueError, TypeError):

flash('Please enter a valid port number (1-65535)', 'error')

return redirect(url_for('index'))



smtp_servers = {

'gmail': ('smtp.gmail.com', 587),

'outlook': ('smtp-mail.outlook.com', 587),

'yahoo': ('smtp.mail.yahoo.com', 587),

'custom': (custom_smtp, int(custom_port))

}



smtp_server, smtp_port = smtp_servers.get(smtp_provider, ('smtp.gmail.com', 587))



smtp_config = {

'smtp_server': smtp_server,

'smtp_port': smtp_port,

'username': username,

'password': password,

'from_email': from_email

}



recipients = []

csv_file = request.files.get('csv_file')

manual_emails = request.form.get('manual_emails')



if csv_file and csv_file.filename and allowed_file(csv_file.filename, ALLOWED_EXTENSIONS):

filename = secure_filename(csv_file.filename)

filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)

csv_file.save(filepath)

recipients = parse_csv(filepath)

os.remove(filepath)



if recipients is None:

return redirect(url_for('index'))

elif manual_emails:

email_list = [email.strip() for email in manual_emails.split(',') if email.strip()]

recipients = [{'email': email, 'name': '', 'custom1': '', 'custom2': ''} for email in email_list]

else:

flash('Please provide recipients via CSV or manual entry', 'error')

return redirect(url_for('index'))



attachment_paths = []

attachments = request.files.getlist('attachments')

for attachment in attachments:

if attachment and attachment.filename and allowed_file(attachment.filename, ATTACHMENT_EXTENSIONS):

filename = secure_filename(attachment.filename)

filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)

attachment.save(filepath)

attachment_paths.append(filepath)



success_count = 0

failed_count = 0

errors = []



for recipient in recipients:

success, error = send_email(smtp_config, recipient, subject, message, attachment_paths)

if success:

success_count += 1

else:

failed_count += 1

errors.append(f"{recipient['email']}: {error}")



for filepath in attachment_paths:

if os.path.exists(filepath):

os.remove(filepath)



flash(f'Successfully sent {success_count} emails. Failed: {failed_count}', 'success' if failed_count == 0 else 'warning')



if errors:

for error in errors[:5]:

flash(error, 'error')



return redirect(url_for('index'))

@app.route('/preview', methods=['POST'])

def preview():

subject = request.form.get('subject', '')

message = request.form.get('message', '')



sample_data = {

'email': 'example@email.com',

'name': 'John Doe',

'custom1': 'Value1',

'custom2': 'Value2'

}



preview_subject = personalize_message(subject, sample_data)

preview_message = personalize_message(message, sample_data)



return jsonify({

'subject': preview_subject,

'message': preview_message

})

if name == '__main__':

app.run(host='0.0.0.0', port=5000, debug=True)

